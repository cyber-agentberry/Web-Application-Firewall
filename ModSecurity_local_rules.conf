------------------------
# SQLi local rules
#----------------------

# 1001001 - Targeted SQLi detection for 'id' parameter (common DVWA sqli)
SecRule ARGS:id "@rx (?i)(\bunion\b|\bselect\b|\binformation_schema\b|--\s|/\*|\bOR\b\s+1\s*=\s*1|\bUNION\b\s+ALL\s+SELECT)" \
  "id:1001001,phase:2,rev:1,log,t:urlDecode,t:lowercase,pass,msg:'LOCAL-1001001: Suspected SQLi in id param',tag:'dvwa:sqli',severity:CRITICAL"

# 1001002 - Generic SQL keywords in any argument (wider but still conservative)
SecRule ARGS "@rx (?i)(\bselect\b|\binsert\b|\bupdate\b|\bdelete\b|\bdrop\b|\bunion\b|\bexec\b|\bconcat\b|\bload_file\b)" \
  "id:1001002,phase:2,rev:1,log,t:urlDecode,t:lowercase,pass,msg:'LOCAL-1001002: SQL keywords found in arg',tag:'dvwa:sqli',severity:CRITICAL"

# 1001003 - Chained: SQL keyword + comment sequence (reduces false positives)
SecRule ARGS "@rx (?i:(select|union|insert|update|delete|drop))" "id:1001003,phase:2,rev:1,chain,log,t:urlDecode,msg:'LOCAL-1001003: SQL keyword followed by comment'"
  SecRule ARGS "@rx (--\s|#|/\*)" "t:none"

# 1001004 - Detect boolean tautologies commonly used in injections (id param or any arg)
SecRule ARGS "@rx (?i:(\bor\b\s+\d+\s*=\s*\d+|\bor\b\s+'1'\s*=\s*'1'|\bor\b\s+1=1))" \
  "id:1001004,phase:2,rev:1,log,t:urlDecode,t:lowercase,pass,msg:'LOCAL-1001004: Boolean tautology detected in args',tag:'dvwa:sqli',severity:CRITICAL"

# 1001005 - Detect UNION SELECT patterns (common exfil payload)
SecRule ARGS "@rx (?i:\bunion\b\s+(all\s+)?\bselect\b)" \
  "id:1001005,phase:2,rev:1,log,t:urlDecode,t:lowercase,pass,msg:'LOCAL-1001005: UNION SELECT pattern in args',tag:'dvwa:sqli',severity:CRITICAL"

#------------------------
# XSS local_rules
#------------------------

SecRule REQUEST_URI "@beginsWith /DVWA/vulnerabilities/xss_r/" \
  "id:2002001,phase:1,pass,log,t:none,msg:'LOCAL-2002001: XSS reflected page accessed',tag:'dvwa:xss'"

# 2002002 - Detect script tags and inline event handlers in ARGS:name (reflected)
SecRule ARGS:name "@rx (?i:<\s*script\b|on\w+\s*=|javascript:)" \
  "id:2002002,phase:2,log,t:urlDecode,t:lowercase,pass,msg:'LOCAL-2002002: Possible reflected XSS in name param',tag:'dvwa:xss',severity:CRITICAL"

# 2002003 - Detect script tags in ARGS:message (common stored XSS field)
SecRule ARGS:message "@rx (?i:<\s*script\b|on\w+\s*=|javascript:)" \
  "id:2002003,phase:2,log,t:urlDecode,t:lowercase,pass,msg:'LOCAL-2002003: Possible stored XSS in message param',tag:'dvwa:xss',severity:CRITICAL"

# 2002004 - Generic ARGS rule (wider â€” keep log-only) to catch other param names
SecRule ARGS "@rx (?i:<\s*script\b|on\w+\s*=|javascript:|<\s*img\b.*onerror)" \
  "id:2002004,phase:2,log,t:urlDecode,t:lowercase,pass,msg:'LOCAL-2002004: Generic XSS pattern in args',tag:'dvwa:xss',severity:CRITICAL"

#-----------------------
# CSRF Local_rules
# ---------------------

SecRule REQUEST_METHOD "POST" \
    "id:3004001,\
    phase:2,\
    msg:'Possible CSRF attack: missing CSRF token',\
    severity:WARNING,\
    deny,\
    chain"
    SecRule ARGS_NAMES "!@contains csrf"

SecRule REQUEST_METHOD "POST" \
    "id:3004002,\
    phase:2,\
    msg:'Possible CSRF attack: invalid or missing Referer header',\
    severity:WARNING,\
    deny,\
    chain"
    SecRule REQUEST_HEADERS:Referer "!@beginsWith http://172.20.10.4"

SecRule REQUEST_URI "@endsWith /DVWA/vulnerabilities/csrf/" \
    "id:3004003,\
    phase:2,\
    msg:'CSRF attempt on DVWA password change',\
    severity:CRITICAL,\
    deny,\
    chain"
    SecRule ARGS:password_new ".+" \
        "chain"
    SecRule ARGS:csrf_token "!@validateByteRange 32-126"

